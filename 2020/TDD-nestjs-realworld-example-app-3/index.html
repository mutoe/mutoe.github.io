<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.mutoe.com","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};</script><meta name="description" content="上一章我们创建了一个用户表, 但是还没有实现真正的注册和登录. 要实现注册登录以及后续的权限校验, 我们还有一些工作要做. 目前有比较多的思路来对用户进行鉴权, 我们选用 Conduit 示例中展示的也是现在比较广泛的做法 JWT 进行认证. 要实现 JWT 鉴权, NestJS 为我们做好了大部分工作. 1. 安装依赖但是在这之前, 我们要先安装下面的依赖 12yarn add @nestjs&#x2F;"><meta property="og:type" content="article"><meta property="og:title" content="手把手带你实践 TDD Nestjs Realworld 项目 - 3. 鉴权认证"><meta property="og:url" content="https://blog.mutoe.com/2020/TDD-nestjs-realworld-example-app-3/"><meta property="og:site_name" content="木头的博客"><meta property="og:description" content="上一章我们创建了一个用户表, 但是还没有实现真正的注册和登录. 要实现注册登录以及后续的权限校验, 我们还有一些工作要做. 目前有比较多的思路来对用户进行鉴权, 我们选用 Conduit 示例中展示的也是现在比较广泛的做法 JWT 进行认证. 要实现 JWT 鉴权, NestJS 为我们做好了大部分工作. 1. 安装依赖但是在这之前, 我们要先安装下面的依赖 12yarn add @nestjs&#x2F;"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://static.mutoe.com/2020/TDD-nestjs-realworld-example-app/hashed-password.png"><meta property="article:published_time" content="2020-01-08T07:32:50.000Z"><meta property="article:modified_time" content="2020-03-22T06:02:34.173Z"><meta property="article:author" content="mutoe"><meta property="article:tag" content="Nestjs"><meta property="article:tag" content="TypeScript"><meta property="article:tag" content="Postgres"><meta property="article:tag" content="TypeORM"><meta property="article:tag" content="JWT"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://static.mutoe.com/2020/TDD-nestjs-realworld-example-app/hashed-password.png"><link rel="canonical" href="https://blog.mutoe.com/2020/TDD-nestjs-realworld-example-app-3/"><script id="page-configurations">// https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };</script><title>手把手带你实践 TDD Nestjs Realworld 项目 - 3. 鉴权认证 | 木头的博客</title><noscript><style>.use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }</style></noscript><link rel="alternate" href="/atom.xml" title="木头的博客" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">木头的博客</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">我是木头 有些想法 有点精力</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.mutoe.com/2020/TDD-nestjs-realworld-example-app-3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="mutoe"><meta itemprop="description" content="木头 前端学徒 有梦想的FED"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="木头的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">手把手带你实践 TDD Nestjs Realworld 项目 - 3. 鉴权认证<a href="https://github.com/mutoe/mutoe.github.io/tree/master/source/_posts/TDD-nestjs-realworld-example-app-3.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pencil"></i></a></h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-01-08 15:32:50" itemprop="dateCreated datePublished" datetime="2020-01-08T15:32:50+08:00">2020-01-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-03-22 14:02:34" itemprop="dateModified" datetime="2020-03-22T14:02:34+08:00">2020-03-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">教程</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>上一章我们创建了一个用户表, 但是还没有实现真正的注册和登录. 要实现注册登录以及后续的权限校验, 我们还有一些工作要做.</p><p>目前有比较多的思路来对用户进行鉴权, 我们选用 Conduit 示例中展示的也是现在比较广泛的做法 JWT 进行认证.</p><p>要实现 JWT 鉴权, NestJS 为我们做好了大部分工作.</p><h1 id="1-安装依赖"><a href="#1-安装依赖" class="headerlink" title="1. 安装依赖"></a>1. 安装依赖</h1><p>但是在这之前, 我们要先安装下面的依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add @nestjs/passport passport passport-local</span><br><span class="line">yarn add -D @types/passport-local</span><br></pre></td></tr></table></figure><p>Passport 你可以把它看作是一个小型的框架, 因为你可以通过一些简单的回调函数来进行配置. Passport 会在适当的时候对其进行调用.</p><p>而 <code>@nestjs/passport</code> 则对 Passport 进行了很好的集成.</p><a id="more"></a><h1 id="2-修改用户表"><a href="#2-修改用户表" class="headerlink" title="2. 修改用户表"></a>2. 修改用户表</h1><p>我们还缺少用户密码存储的地方</p><p>我们在 <code>user.entity.ts</code> 增加一个密码字段</p><figure class="highlight diff"><figcaption><span>user.entity.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">export class User &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  @Column(&#123; length: 20 &#125;)</span><br><span class="line">  username: string</span><br><span class="line"></span><br><span class="line"><span class="addition">+ @Column()</span></span><br><span class="line"><span class="addition">+ password: string</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">  @Column(&#123; nullable, type: 'text' &#125;)</span><br><span class="line">  bio: null | string</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后清空数据表, 重新请求 register 方法, 可以看到, 我们的密码字段自动更新在了表中</p><h1 id="3-创建-Auth-模块"><a href="#3-创建-Auth-模块" class="headerlink" title="3. 创建 Auth 模块"></a>3. 创建 Auth 模块</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nest g module auth</span><br><span class="line">nest g service auth</span><br></pre></td></tr></table></figure><p>我们的 AuthService 提供一个验证用户密码是否匹配的接口. 好, 先写测试</p><figure class="highlight ts"><figcaption><span>auth.service.spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Test, TestingModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/testing'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">'../user/user.entity'</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'../user/user.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getRepositoryToken &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'AuthService'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> authService: AuthService</span><br><span class="line">  <span class="keyword">let</span> userService: UserService</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">module</span>: TestingModule = await Test.createTestingModule(&#123;</span><br><span class="line">      providers: [</span><br><span class="line">        UserService,</span><br><span class="line">        AuthService,</span><br><span class="line">        &#123;</span><br><span class="line">          provide: getRepositoryToken(User),</span><br><span class="line">          useValue: &#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;).compile()</span><br><span class="line"></span><br><span class="line">    authService = <span class="built_in">module</span>.<span class="keyword">get</span>(AuthService)</span><br><span class="line">    userService = <span class="built_in">module</span>.<span class="keyword">get</span>(UserService)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should get user profile after validateUser'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> password = <span class="string">'12345678'</span></span><br><span class="line">    <span class="keyword">const</span> username = <span class="string">'mutoe'</span></span><br><span class="line">    jest</span><br><span class="line">      .spyOn(userService, <span class="string">'findOne'</span>)</span><br><span class="line">      .mockResolvedValue(&#123; username, password &#125; <span class="keyword">as</span> User)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> authService.validateUser(username, password)</span><br><span class="line"></span><br><span class="line">    expect(user).toHaveProperty(<span class="string">'username'</span>, username)</span><br><span class="line">    expect(user).not.toHaveProperty(<span class="string">'password'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should return null when invalid password'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    jest.spyOn(userService, <span class="string">'findOne'</span>).mockResolvedValue(<span class="literal">undefined</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> authService.validateUser(<span class="string">'mutoe'</span>, <span class="string">'invalidPassword'</span>)</span><br><span class="line"></span><br><span class="line">    expect(result).toBeNull()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>我们期望 AuthService 中验证通过后, 返回的用户信息中不含有 <code>password</code> 字段; 如果密码输入错误, 应该返回 <code>null</code></p><p>然后写实现</p><figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'../user/user.service'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthService &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly userService: UserService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validateUser(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(username)</span><br><span class="line">    <span class="keyword">if</span> (user?.password === password) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; password, ...profile &#125; = user</span><br><span class="line">      <span class="keyword">return</span> profile</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>你知道吗<br><code>user?.password</code> 是 TS3.7 的新语法: <a href="https://github.com/tc39/proposal-optional-chaining" target="_blank" rel="noopener">“optional-chaining”</a>, 这个语法在 ES 中目前是 Stage4, 可以放心的在项目中使用.</p></blockquote><p>UserService 下没有实现 <code>findOne</code> ?, 写!</p><figure class="highlight ts"><figcaption><span>user.service.spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">beforeEach(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">module</span>: TestingModule = await Test.createTestingModule(&#123;</span><br><span class="line">    providers: [</span><br><span class="line">      UserService,</span><br><span class="line">      &#123;</span><br><span class="line">        provide: getRepositoryToken(User),</span><br><span class="line">        useValue: &#123;</span><br><span class="line">          save: jest.fn(),</span><br><span class="line">          findOne: jest.fn(),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;).compile()</span><br><span class="line"></span><br><span class="line">  service = <span class="built_in">module</span>.<span class="keyword">get</span>(UserService)</span><br><span class="line">  repository = <span class="built_in">module</span>.<span class="keyword">get</span>(getRepositoryToken(User))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">it(<span class="string">'should find user correctly'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    email: <span class="string">'mutoe@foxmail.com'</span>,</span><br><span class="line">    username: <span class="string">'mutoe'</span>,</span><br><span class="line">    password: <span class="string">'12345678'</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  jest.spyOn(repository, <span class="string">'findOne'</span>).mockResolvedValue(user <span class="keyword">as</span> User)</span><br><span class="line">  <span class="keyword">const</span> userResult = <span class="keyword">await</span> service.findOne(user.username)</span><br><span class="line"></span><br><span class="line">  expect(userResult).toBe(user)</span><br><span class="line">  expect(repository.findOne).toBeCalledWith(&#123;</span><br><span class="line">    where: &#123; username: user.username &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>实现</p><figure class="highlight ts"><figcaption><span>user.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserService &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">async</span> findOne(username: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userRepository.findOne(&#123; where: &#123; username &#125; &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-密码散列和环境变量"><a href="#4-密码散列和环境变量" class="headerlink" title="4. 密码散列和环境变量"></a>4. 密码散列和环境变量</h1><p>为了避免用户的明文密码暴露, 我们存在数据库的密码必须经过<a href="https://zh.wikipedia.org/wiki/%E5%AF%86%E7%A2%BC%E9%9B%9C%E6%B9%8A%E5%87%BD%E6%95%B8" target="_blank" rel="noopener">散列加密</a>.</p><p>我们使用 nodejs 自带的 crypto 库的 <code>cryptoHmac</code> 进行散列加密. 为了提高安全性, 我们还可以添加自己的加密 key, 这个 key 我们要放在环境变量中, 避免把它硬编码在代码中上传到代码库.</p><p>那如何做呢? 一种方法是创建我们的模版配置文件, 这个可以参考我以前写的帖子 <a href="/2016/manage-config-template-in-git/">在 Git 中使用模版来管理配置文件</a>, 另一种方法就是使用 <code>dotenv</code> 库. 我更偏向于使用后一种方式.</p><h2 id="5-1-设置环境变量"><a href="#5-1-设置环境变量" class="headerlink" title="5.1 设置环境变量"></a>5.1 设置环境变量</h2><p>幸运的是, TypeORM 中内置了这个 <code>dotenv</code> 库, 所以我们不必在额外安装它了.</p><p>在项目根目录下创建一个 <code>.env.template</code> 文件. 我们在使用时, 可以将该文件拷贝一份并且重命名为 <code>.env</code>, dotenv 就会读取 <code>.env</code> 中的配置.</p><p>我们还可以将我们的数据库连接信息加入到该文件中, 避免信息泄露. 有关 TypeORM 提供的环境变量 key, 可以<a href="https://typeorm.io/#/using-ormconfig/%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" target="_blank" rel="noopener">参阅这里</a></p><figure class="highlight ini"><figcaption><span>.env.template</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># App</span></span><br><span class="line"><span class="attr">NEST_SECRET</span> = change-me</span><br><span class="line"></span><br><span class="line"><span class="comment"># Database</span></span><br><span class="line"><span class="attr">TYPEORM_CONNECTION</span> = postgres</span><br><span class="line"><span class="attr">TYPEORM_HOST</span> = localhost</span><br><span class="line"><span class="attr">TYPEORM_USERNAME</span> = root</span><br><span class="line"><span class="attr">TYPEORM_PASSWORD</span> =</span><br><span class="line"><span class="attr">TYPEORM_DATABASE</span> = nestjs</span><br><span class="line"><span class="attr">TYPEORM_PORT</span> = <span class="number">5432</span></span><br><span class="line"><span class="attr">TYPEORM_SYNCHRONIZE</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">TYPEORM_LOGGING</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">TYPEORM_ENTITIES</span> = dist/**/*.entity.js</span><br></pre></td></tr></table></figure><p>现在我们的环境变量的模版文件就创建好啦, 我们使用时应该将该文件复制一份为<code>.env</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp .env.template .env</span><br></pre></td></tr></table></figure><p>复制完毕后将其中的 secret 和数据库连接信息修改成我们自己的数据</p><p>我们还应该将 <code>.env</code> 文件加入 git 忽略列表, 避免我们的这些敏感信息泄漏.</p><p>然后创建 <code>src/config.ts</code>, 读取这些环境变量</p><figure class="highlight ts"><figcaption><span>config.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NEST_SECRET = process.env.NEST_SECRET ?? <span class="string">'secret'</span></span><br></pre></td></tr></table></figure><p>因为我们刚才已经将数据库连接信息写在了环境变量中, 所以我们之前在代码中的硬编码就可以移除啦</p><figure class="highlight diff"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line"><span class="deletion">-   TypeOrmModule.forRoot(&#123;</span></span><br><span class="line"><span class="deletion">-     type: 'postgres',</span></span><br><span class="line"><span class="deletion">-     host: 'localhost',</span></span><br><span class="line"><span class="deletion">-     port: 5432,</span></span><br><span class="line"><span class="deletion">-     username: 'realworld',</span></span><br><span class="line"><span class="deletion">-     password: '123456',</span></span><br><span class="line"><span class="deletion">-     database: 'nestjs',</span></span><br><span class="line"><span class="deletion">-     entities: ['dist/**/*.entity.js'],</span></span><br><span class="line"><span class="deletion">-     synchronize: true,</span></span><br><span class="line"><span class="deletion">-   &#125;),</span></span><br><span class="line"><span class="addition">+   TypeOrmModule.forRoot(),</span></span><br><span class="line">    TypeOrmModule.forFeature([UserEntity]),</span><br><span class="line">    UserModule,</span><br><span class="line">    AuthModule,</span><br><span class="line">  ],</span><br><span class="line">  exports: [TypeOrmModule],</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [AppService, UserService],</span><br><span class="line">&#125;)</span><br><span class="line">export class AppModule &#123;</span><br><span class="line">  constructor (private readonly connection: Connection) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>环境变量创建好之后, 我们以后读取配置就在 <code>src/config.ts</code> 中使用啦!</p><h2 id="5-2-密码散列函数"><a href="#5-2-密码散列函数" class="headerlink" title="5.2 密码散列函数"></a>5.2 密码散列函数</h2><p>我们在 <code>src</code> 目录下创建一个 <code>utils.ts</code> 的文件, 用于存放我们的工具类方法.</p><figure class="highlight ts"><figcaption><span>utils.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> crypto <span class="keyword">from</span> <span class="string">'crypto'</span></span><br><span class="line"><span class="keyword">import</span> &#123; NEST_SECRET &#125; <span class="keyword">from</span> <span class="string">'./config'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">cryptoPassword</span>(<span class="params">password: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hmac = crypto.createHmac(<span class="string">'sha256'</span>, NEST_SECRET)</span><br><span class="line">  <span class="keyword">return</span> hmac.update(password).digest(<span class="string">'hex'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对了, 测试还没写, 补个测试 (这一点都不 TDD 啊!)</p><figure class="highlight ts"><figcaption><span>utils.spec.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; cryptoPassword &#125; <span class="keyword">from</span> <span class="string">'./utils'</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">'Utilities'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'cryptoPassword'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hashedPassword = cryptoPassword(<span class="string">'foobar'</span>)</span><br><span class="line">    <span class="keyword">const</span> hashedResult =</span><br><span class="line">      <span class="string">'4fcc06915b43d8a49aff193441e9e18654e6a27c2c428b02e8fcc41ccc2299f9'</span></span><br><span class="line"></span><br><span class="line">    expect(hashedPassword).toBe(hashedResult)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="5-3-密码散列加密"><a href="#5-3-密码散列加密" class="headerlink" title="5.3 密码散列加密"></a>5.3 密码散列加密</h2><p>现在散列加密函数有了, 我们应该在哪里对密码进行加密呢. TypeORM 提供了一组监听器, 当我们对数据进行操作时, 如果设置了监听器, TypeORM 就会触发这个监听器.</p><p>我们要在用户创建和更新的时候, 对密码进行加密, 所以我们要使用 <code>BeforeInsert</code> 和 <code>BeforeUpdate</code> 两个监听器</p><figure class="highlight ts"><figcaption><span>user.entity.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BeforeInsert, BeforeUpdate, Column, Entity, PrimaryGeneratedColumn &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span></span><br><span class="line"><span class="keyword">import</span> &#123; cryptoPassword &#125; <span class="keyword">from</span> <span class="string">'../utils'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserEntity &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; password: <span class="number">64</span> &#125;)</span><br><span class="line">  password: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@BeforeInsert</span></span><br><span class="line">  <span class="meta">@BeforeUpdate</span></span><br><span class="line">  hashPassword() &#123;</span><br><span class="line">    <span class="keyword">this</span>.password = cryptoPassword(<span class="keyword">this</span>.password)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启下服务器, 然后发起一个 register 请求, 看看用户密码是不是被散列加密保存了</p><p><img src="https://static.mutoe.com/2020/TDD-nestjs-realworld-example-app/hashed-password.png" alt="hashed password"></p><p>不要忘记修改我们 AuthService 中验证密码的方法哦</p><figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BadRequestException, Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'../user/user.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; cryptoPassword &#125; <span class="keyword">from</span> <span class="string">'../utils'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthService &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly userService: UserService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validateUser(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(username)</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">'user is not exist'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (user.password !== cryptoPassword(password)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">'password is invalid'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; password: _, ...profile &#125; = user</span><br><span class="line">    <span class="keyword">return</span> profile</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5-实现本地认证策略"><a href="#5-实现本地认证策略" class="headerlink" title="5. 实现本地认证策略"></a>5. 实现本地认证策略</h1><p>为了简化我们的认证策略, 我们使用了一个名为 <code>passport-local</code> 的库, 在使用时,我们只需要将自己的类继承该库, 然后在构造函数中调用父类的构造函数即可.</p><p>我们在 <code>auth</code> 目录下创建一个 <code>local.strategy.ts</code> 文件</p><p>对于每种策略, Passport 要求实现一个具有以下签名的方法</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validate(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>): <span class="built_in">any</span></span><br></pre></td></tr></table></figure><p>任何 Passport 策略都将遵循这个模式.</p><p>我们的 <code>validate</code> 方法, 调用 <code>AuthService</code> 的 <code>validateUser</code> 方法, 如果没有通过校验, 就抛出一个 401 错误, 否则返回该用户的信息</p><figure class="highlight ts"><figcaption><span>local.strategy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, UnauthorizedException &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Strategy &#125; <span class="keyword">from</span> <span class="string">'passport-local'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> LocalStrategy <span class="keyword">extends</span> PassportStrategy(Strategy) &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly authService: AuthService</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validate(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.authService.validateUser(username, password)</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在 AuthModule 中引用这个策略</p><figure class="highlight ts"><figcaption><span>auth.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">'../user/user.module'</span></span><br><span class="line"><span class="keyword">import</span> &#123; PassportModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span></span><br><span class="line"><span class="keyword">import</span> &#123; LocalStrategy &#125; <span class="keyword">from</span> <span class="string">'./local.strategy'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  imports: [UserModule, PassportModule],</span><br><span class="line">  providers: [AuthService, LocalStrategy],</span><br><span class="line">  exports: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure><h1 id="5-实现登录功能"><a href="#5-实现登录功能" class="headerlink" title="5. 实现登录功能"></a>5. 实现登录功能</h1><p>nestjs 为我们提供了一个非常方便的功能用来检测请求是否由路由处理程序, 这个功能就是守卫.</p><p>守卫内部实现了一个名为 <code>canActive</code> 的方法, 它返回一个 boolean 值, 如果为真, 就会处理这个路由,否则将会忽略当前的请求.</p><p>利用守卫, 我们可以方便的进行权限校验. 有点麻烦的是, 当用户未登录时, 我们首先应该校验用户访问的路由是否受限, 当没有经过身份验证的用户尝试登录时, 应该启动身份验证步骤.</p><p>不用担心, <code>@nestjs/passport</code> 为我们提供了一个比较便捷的守卫 <code>AuthGuard</code>, 结合 local 策略, 我们可以方便的获取用户信息, 验证通过后, 可以在 <code>request.user</code> 字段获取到, 其内容就是 local 策略 <code>validate</code> 方法返回的内容</p><p>由于<ruby>篇幅问题<rt>tōu lǎn<rt></rt></rt></ruby>, 我就省略测试的部分了, 直接亮代码!</p><p>登录入口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query, UseGuards &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user/user.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth/auth.service'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppController &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> readonly userService: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> readonly authService: AuthService,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(AuthGuard(<span class="string">'local'</span>))</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">'/auth/login'</span>)</span><br><span class="line">  <span class="keyword">async</span> login(<span class="meta">@Request</span>() req) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user &#125; = req</span><br><span class="line">    <span class="keyword">return</span> &#123; user &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后发起一个 login 请求, 现在应该可以正常返回用户的信息了.</p><h1 id="6-JWT-认证"><a href="#6-JWT-认证" class="headerlink" title="6. JWT 认证"></a>6. JWT 认证</h1><p>等等! 现在只是得到了一个用户信息, 那我怎么得到的我的 token 用来后续的鉴权呢?</p><h2 id="6-1-生成-Token"><a href="#6-1-生成-Token" class="headerlink" title="6.1 生成 Token"></a>6.1 生成 Token</h2><p>生成 Token 使用 <code>passport-jwt</code> 和 <code>@nestjs/jwt</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add @nestjs/jwt passport-jwt</span><br><span class="line">yarn add -D @types/passport-jwt</span><br></pre></td></tr></table></figure><p>我们将生成 token 的部分放在 AuthService 中</p><figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthService &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  generateToken(userId: <span class="built_in">number</span>, username: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jwtService.sign(&#123; userId, username &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意: 上面 <code>sign</code> 的参数的内容并不是加密的, 拿到 token 后可以解密成明文内容, 所以这部分不要放敏感信息.</p></blockquote><p>在使用前我们还需要一点点准备工作, 我们需要注册这个 JWT module.</p><p>在 AuthModule 中导入 <code>JwtModule</code> 的 <code>register</code> 方法, 传入我们签名的 <code>secret</code></p><figure class="highlight ts"><figcaption><span>auth.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> &#123; JwtModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span></span><br><span class="line"><span class="keyword">import</span> &#123; NEST_SECRET &#125; <span class="keyword">from</span> <span class="string">'../config'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    UserModule,</span><br><span class="line">    PassportModule,</span><br><span class="line">    JwtModule.register(&#123;</span><br><span class="line">      secret: NEST_SECRET,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  providers: [AuthService, LocalStrategy],</span><br><span class="line">  exports: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>修改一下我们的 login 方法, 首先读取到用户信息后, 生成一个 token 给用户. 按照 Conduit 的规则, 我们将 token 注入在 <code>user</code> 对象中</p><figure class="highlight ts"><figcaption><span>app.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@UseGuards</span>(AuthGuard(<span class="string">'local'</span>))</span><br><span class="line"><span class="meta">@Post</span>(<span class="string">'/auth/login'</span>)</span><br><span class="line"><span class="keyword">async</span> login (<span class="meta">@Request</span>() req) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; user &#125; = req</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">this</span>.authService.generateToken(user.id, user.username)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    user: &#123; ...user, token &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在调用 login 方法, 返回的信息中应该含有 token 了, 我们在客户端拿到后, 应该将它进行持久化保存, 以便于后续的受保护的请求使用</p><h2 id="6-2-实现-JWT-策略"><a href="#6-2-实现-JWT-策略" class="headerlink" title="6.2 实现 JWT 策略"></a>6.2 实现 JWT 策略</h2><p>在 Auth 模块下创建一个<code>jwt.strategy.ts</code> 的文件</p><figure class="highlight ts"><figcaption><span>jwt.strategy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span></span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ExtractJwt, Strategy &#125; <span class="keyword">from</span> <span class="string">'passport-jwt'</span></span><br><span class="line"><span class="keyword">import</span> &#123; NEST_SECRET &#125; <span class="keyword">from</span> <span class="string">'../config'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> JwtStrategy <span class="keyword">extends</span> PassportStrategy(Strategy) &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),</span><br><span class="line">      ignoreExpiration: <span class="literal">false</span>,</span><br><span class="line">      secretOrKey: NEST_SECRET,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  validate(payload: &#123; userId: <span class="built_in">number</span>; username: <span class="built_in">string</span> &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; userId, username &#125; = payload</span><br><span class="line">    <span class="keyword">return</span> &#123; userId, username &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为有了 <code>passport-jwt</code>, 我们的 jwt 策略依旧很简单, 继承 Passport 策略后我们只需要设置如何获取 jwt, 解析规则即可</p><p>最后我们将 JWT 策略提供给我们的 AuthModule</p><figure class="highlight ts"><figcaption><span>auth.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  providers: [AuthService, LocalStrategy, JwtStrategy],</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>好, 现在我们就有了 2 个策略, ‘local’ 策略用来保护我们的路由, ‘jwt’ 策略用来鉴别请求有效性并且提供用户信息</p><h2 id="6-3-验证一下"><a href="#6-3-验证一下" class="headerlink" title="6.3 验证一下"></a>6.3 验证一下</h2><p>一切准备工作就绪后, 我们怎么使用 JWT 呢? 上一步我们实现 JWT 策略之后, 可以继续用 Guard 来保护我们的路由</p><p>为了演示使用方法, 我们实现一个读取个人资料的功能,</p><p>根据 Conduit 的要求, 我们的请求地址是 GET <code>/user</code>, 返回的内容暂时读取 jwt 的 payload 好啦</p><p>首先创建一个路由</p><figure class="highlight ts"><figcaption><span>app.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@UseGuards</span>(AuthGuard(<span class="string">'jwt'</span>))</span><br><span class="line"><span class="meta">@Get</span>(<span class="string">'/user'</span>)</span><br><span class="line"><span class="keyword">async</span> profile (<span class="meta">@Request</span>() req) &#123;</span><br><span class="line">  <span class="keyword">return</span> req.user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启服务, 然后我们发起一个不带有 Token 的请求头的 GET 请求访问一下这个路由</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:3000/user</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt; &#123;"statusCode":401,"error":"Unauthorized"&#125;</span></span><br></pre></td></tr></table></figure><p>成功的返回了 401 错误, 接下来带上我们的 token 试试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3000/auth/login -H <span class="string">'Content-Type:application/json'</span> -d <span class="string">'&#123;"username":"foo","password":"12345678"&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt; &#123;"user":&#123;"id":5,"email":"foo@bar.com","username":"foo","bio":null,"image":null,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjUsInVzZXJuYW1lIjoiZm9vIiwiaWF0IjoxNTc4NDY2OTI4fQ.4k5F5VVY-lS86FxAwLIQ9lc8fB8_VRLA0E2_ekbP_lE"&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">curl http://localhost:3000/user -H <span class="string">"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjUsInVzZXJuYW1lIjoiZm9vIiwiaWF0IjoxNTc4NDY2OTI4fQ.4k5F5VVY-lS86FxAwLIQ9lc8fB8_VRLA0E2_ekbP_lE"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt; &#123;"userId":5,"username":"foo"&#125;</span></span><br></pre></td></tr></table></figure><p>嗯.. 大功告成!</p><p>好, 小结一下, 我们一共有两个用户身份验证策略, LocalStrategy 做用户名密码验证的守卫, JwtStrategy 用来做 Token 的验证. 之后如果某个接口需要用户登录, 加一个 JwtStrategy 守卫就好啦</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://docs.nestjs.com/techniques/authentication" target="_blank" rel="noopener">Authentication | NestJS</a></li><li><a href="https://docs.nestjs.com/guards" target="_blank" rel="noopener">Guards | NestJS</a></li><li><a href="https://www.shangyang.me/2018/03/07/javascript-nodejs-passport-01-basic/" target="_blank" rel="noopener">Nodejs Passport 系列之一：基础概念</a></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Nestjs/" rel="tag"># Nestjs</a> <a href="/tags/TypeScript/" rel="tag"># TypeScript</a> <a href="/tags/Postgres/" rel="tag"># Postgres</a> <a href="/tags/TypeORM/" rel="tag"># TypeORM</a> <a href="/tags/JWT/" rel="tag"># JWT</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/TDD-nestjs-realworld-example-app-2/" rel="prev" title="手把手带你实践 TDD Nestjs Realworld 项目 - 2. 数据库连接"><i class="fa fa-chevron-left"></i> 手把手带你实践 TDD Nestjs Realworld 项目 - 2. 数据库连接</a></div><div class="post-nav-item"><a href="/2020/TDD-nestjs-realworld-example-app-4/" rel="next" title="手把手带你实践 TDD Nestjs Realworld 项目 - 4. 输入校验和转化">手把手带你实践 TDD Nestjs Realworld 项目 - 4. 输入校验和转化 <i class="fa fa-chevron-right"></i></a></div></div></footer><script src="https://utteranc.es/client.js" repo="mutoe/blog" issue-term="title" label="comment" theme="github-light" crossorigin="anonymous" async></script></article></div></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-安装依赖"><span class="nav-text">1. 安装依赖</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-修改用户表"><span class="nav-text">2. 修改用户表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-创建-Auth-模块"><span class="nav-text">3. 创建 Auth 模块</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-密码散列和环境变量"><span class="nav-text">4. 密码散列和环境变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-设置环境变量"><span class="nav-text">5.1 设置环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-密码散列函数"><span class="nav-text">5.2 密码散列函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-密码散列加密"><span class="nav-text">5.3 密码散列加密</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-实现本地认证策略"><span class="nav-text">5. 实现本地认证策略</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-实现登录功能"><span class="nav-text">5. 实现登录功能</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-JWT-认证"><span class="nav-text">6. JWT 认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-生成-Token"><span class="nav-text">6.1 生成 Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-实现-JWT-策略"><span class="nav-text">6.2 实现 JWT 策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-验证一下"><span class="nav-text">6.3 验证一下</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="mutoe" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">mutoe</p><div class="site-description" itemprop="description">木头 前端学徒 有梦想的FED</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">39</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">42</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/mutoe/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;mutoe&#x2F;" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:mutoe@foxmail.com" title="E-Mail → mailto:mutoe@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">mutoe</span></div><div class="external-link"><a href="/sponsor">拥抱开源</a> <a href="/quick">学习资料导航</a> <a href="/npm">常用 npm 包</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script>(function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();</script></body></html>